<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSVãƒ•ã‚¡ã‚¤ãƒ«çªåˆãƒ„ãƒ¼ãƒ«</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        
        .upload-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .file-upload {
            border: 2px dashed #4285f4;
            padding: 20px;
            text-align: center;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        .file-upload:hover {
            background: #e3f2fd;
        }
        
        input[type="file"] {
            margin: 10px 0;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            align-items: end;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        label {
            font-weight: bold;
            color: #555;
        }
        
        select, button {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        button {
            background: #4285f4;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
        
        button:hover {
            background: #3367d6;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .results {
            margin-top: 30px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid #e9ecef;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #4285f4;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 10px 15px;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .tab.active {
            background: #4285f4;
            color: white;
            border-color: #4285f4;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 13px;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        th {
            background: #4285f4;
            color: white;
        }
        
        tr:nth-child(even) {
            background: #f9f9f9;
        }
        
        .diff-added {
            background: #e8f5e8;
            border-left: 3px solid #4caf50;
        }
        
        .diff-removed {
            background: #fce8e6;
            border-left: 3px solid #f44336;
        }
        
        .diff-changed {
            background: #fff3cd;
            border-left: 3px solid #ffc107;
        }
        
        .export-buttons {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .export-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .export-btn:hover {
            background: #218838;
        }
        
        .file-info {
            margin-top: 10px;
            font-size: 12px;
            color: #666;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        @media (max-width: 768px) {
            .upload-section {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .tabs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š TSVãƒ•ã‚¡ã‚¤ãƒ«çªåˆãƒ„ãƒ¼ãƒ«</h1>
        
        <!-- å‹•ä½œç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
        <div id="status" style="background: #d4edda; color: #155724; padding: 10px; border-radius: 4px; margin-bottom: 20px;">
            âœ… ãƒ„ãƒ¼ãƒ«ãŒæ­£å¸¸ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ
            <br><small>ğŸ’¡ å¯¾å¿œå½¢å¼: TSV (ã‚¿ãƒ–åŒºåˆ‡ã‚Š), CSV (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š), ã‚»ãƒŸã‚³ãƒ­ãƒ³åŒºåˆ‡ã‚Š, ãƒ‘ã‚¤ãƒ—åŒºåˆ‡ã‚Š</small>
        </div>
        
        <div class="upload-section">
            <div class="file-upload">
                <h3>ãƒ•ã‚¡ã‚¤ãƒ«1</h3>
                <input type="file" id="file1" accept=".tsv,.txt,.csv,.dat" onchange="handleFile(1, this)">
                <div class="file-info" id="info1"></div>
            </div>
            
            <div class="file-upload">
                <h3>ãƒ•ã‚¡ã‚¤ãƒ«2</h3>
                <input type="file" id="file2" accept=".tsv,.txt,.csv,.dat" onchange="handleFile(2, this)">
                <div class="file-info" id="info2"></div>
            </div>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <label for="keyColumn">ã‚­ãƒ¼åˆ—</label>
                <select id="keyColumn">
                    <option value="">ã‚­ãƒ¼åˆ—ã‚’é¸æŠ</option>
                </select>
            </div>
            
            <button onclick="compareFiles()" id="compareBtn" disabled>ğŸš€ æ¯”è¼ƒå®Ÿè¡Œ</button>
            <button onclick="clearAll()" style="background: #dc3545;">ğŸ—‘ï¸ å…¨ã‚¯ãƒªã‚¢</button>
        </div>
        
        <div class="results" id="results" style="display: none;">
            <div class="stats" id="stats"></div>
            
            <div class="tabs">
                <div class="tab active" onclick="showTab('summary')">ã‚µãƒãƒªãƒ¼</div>
                <div class="tab" onclick="showTab('details')">è©³ç´°</div>
                <div class="tab" onclick="showTab('added')">è¿½åŠ </div>
                <div class="tab" onclick="showTab('removed')">å‰Šé™¤</div>
                <div class="tab" onclick="showTab('changed')">å¤‰æ›´</div>
            </div>
            
            <div class="tab-content active" id="summary"></div>
            <div class="tab-content" id="details"></div>
            <div class="tab-content" id="added"></div>
            <div class="tab-content" id="removed"></div>
            <div class="tab-content" id="changed"></div>
            
            <div class="export-buttons">
                <button class="export-btn" onclick="exportCSV('all')">å…¨çµæœCSVå‡ºåŠ›</button>
                <button class="export-btn" onclick="exportCSV('diff')">å·®åˆ†ã®ã¿CSVå‡ºåŠ›</button>
            </div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let fileData = { file1: null, file2: null };
        let comparisonResult = null;
        
        console.log('ğŸš€ TSVãƒ„ãƒ¼ãƒ«é–‹å§‹');
        
        // ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
        let originalFileContents = { file1: null, file2: null };
        let originalFileNames = { file1: null, file2: null };
        
        function handleFile(fileNum, input) {
            const file = input.files[0];
            if (!file) return;
            
            console.log(`ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«${fileNum}é¸æŠ:`, file.name);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    
                    // ã‚ªãƒªã‚¸ãƒŠãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                    originalFileContents[`file${fileNum}`] = content;
                    originalFileNames[`file${fileNum}`] = file.name;
                    
                    const data = parseFile(content, file.name);
                    fileData[`file${fileNum}`] = data;
                    
                    updateFileInfo(fileNum, file, data);
                    updateKeyColumnOptions();
                    updateCompareButton();
                    
                    console.log(`âœ… ãƒ•ã‚¡ã‚¤ãƒ«${fileNum}è§£æå®Œäº†:`, data.rows.length, 'è¡Œ');
                } catch (error) {
                    showError(`ãƒ•ã‚¡ã‚¤ãƒ«${fileNum}ã®è§£æã«å¤±æ•—: ${error.message}`);
                    console.error('âŒ ãƒ•ã‚¡ã‚¤ãƒ«è§£æã‚¨ãƒ©ãƒ¼:', error);
                }
            };
            
            reader.readAsText(file, 'UTF-8');
        }
        
        // åŒºåˆ‡ã‚Šæ–‡å­—å¤‰æ›´æ™‚ã®å†å‡¦ç†
        function reprocessFiles() {
            console.log('ğŸ”„ åŒºåˆ‡ã‚Šæ–‡å­—å¤‰æ›´ - ãƒ•ã‚¡ã‚¤ãƒ«å†å‡¦ç†é–‹å§‹');
            
            try {
                // ãƒ•ã‚¡ã‚¤ãƒ«1ã®å†å‡¦ç†
                if (originalFileContents.file1) {
                    const data1 = parseFile(originalFileContents.file1, originalFileNames.file1);
                    fileData.file1 = data1;
                    updateFileInfo(1, { name: originalFileNames.file1 }, data1);
                }
                
                // ãƒ•ã‚¡ã‚¤ãƒ«2ã®å†å‡¦ç†
                if (originalFileContents.file2) {
                    const data2 = parseFile(originalFileContents.file2, originalFileNames.file2);
                    fileData.file2 = data2;
                    updateFileInfo(2, { name: originalFileNames.file2 }, data2);
                }
                
                // ã‚­ãƒ¼åˆ—é¸æŠè‚¢ã‚’æ›´æ–°
                updateKeyColumnOptions();
                
                // çµæœã‚’å®Œå…¨ã«ã‚¯ãƒªã‚¢
                resetResultsDisplay();
                comparisonResult = null;
                
                console.log('âœ… ãƒ•ã‚¡ã‚¤ãƒ«å†å‡¦ç†å®Œäº†');
            } catch (error) {
                showError('ãƒ•ã‚¡ã‚¤ãƒ«å†å‡¦ç†ã‚¨ãƒ©ãƒ¼: ' + error.message);
                console.error('âŒ å†å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«è§£æ
        function parseFile(content, filename) {
            const lines = content.trim().split('\n');
            if (lines.length < 2) {
                throw new Error('ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã¨ãƒ‡ãƒ¼ã‚¿è¡ŒãŒå¿…è¦ã§ã™');
            }
            
            // åŒºåˆ‡ã‚Šæ–‡å­—å–å¾—
            const delimiter = getDelimiter(content, filename);
            console.log('ğŸ” ä½¿ç”¨ã™ã‚‹åŒºåˆ‡ã‚Šæ–‡å­—:', delimiter === '\t' ? 'ã‚¿ãƒ–' : delimiter === ',' ? 'ã‚«ãƒ³ãƒ' : delimiter);
            
            const headers = lines[0].split(delimiter);
            const rows = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(delimiter);
                const row = {};
                headers.forEach((header, index) => {
                    row[header.trim()] = (values[index] || '').trim();
                });
                
                // ç©ºè¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—
                if (Object.values(row).some(val => val !== '')) {
                    rows.push(row);
                }
            }
            
            return { 
                headers: headers.map(h => h.trim()), 
                rows,
                delimiter: delimiter === '\t' ? 'ã‚¿ãƒ–' : delimiter === ',' ? 'ã‚«ãƒ³ãƒ' : delimiter
            };
        }
        
        // åŒºåˆ‡ã‚Šæ–‡å­—åˆ¤å®šé–¢æ•°
        function getDelimiter(content, filename) {
            const delimiterSelect = document.getElementById('delimiter');
            const selectedDelimiter = delimiterSelect ? delimiterSelect.value : 'auto';
            
            // æ‰‹å‹•é¸æŠã®å ´åˆ
            if (selectedDelimiter !== 'auto') {
                switch (selectedDelimiter) {
                    case 'tab': return '\t';
                    case 'comma': return ',';
                    case 'semicolon': return ';';
                    case 'pipe': return '|';
                    default: return '\t';
                }
            }
            
            // è‡ªå‹•åˆ¤å®šã®å ´åˆ
            const firstLine = content.split('\n')[0];
            
            // ãƒ•ã‚¡ã‚¤ãƒ«æ‹¡å¼µå­ã«ã‚ˆã‚‹åˆ¤å®š
            if (filename.toLowerCase().endsWith('.csv')) {
                return ',';
            } else if (filename.toLowerCase().endsWith('.tsv')) {
                return '\t';
            }
            
            // å†…å®¹ã«ã‚ˆã‚‹åˆ¤å®šï¼ˆå„ªå…ˆé †ä½: ã‚¿ãƒ– > ã‚«ãƒ³ãƒ > ã‚»ãƒŸã‚³ãƒ­ãƒ³ > ãƒ‘ã‚¤ãƒ—ï¼‰
            const tabCount = (firstLine.match(/\t/g) || []).length;
            const commaCount = (firstLine.match(/,/g) || []).length;
            const semicolonCount = (firstLine.match(/;/g) || []).length;
            const pipeCount = (firstLine.match(/\|/g) || []).length;
            
            const maxCount = Math.max(tabCount, commaCount, semicolonCount, pipeCount);
            
            if (maxCount === 0) {
                console.warn('âš ï¸ åŒºåˆ‡ã‚Šæ–‡å­—ã‚’æ¤œå‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚¿ãƒ–ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚');
                return '\t';
            }
            
            if (tabCount === maxCount) return '\t';
            if (commaCount === maxCount) return ',';
            if (semicolonCount === maxCount) return ';';
            if (pipeCount === maxCount) return '|';
            
            return '\t'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±æ›´æ–°
        function updateFileInfo(fileNum, file, data) {
            document.getElementById(`info${fileNum}`).innerHTML = 
                `âœ… ${file.name}<br>${data.rows.length} è¡Œ Ã— ${data.headers.length} åˆ—<br>ğŸ“ åŒºåˆ‡ã‚Šæ–‡å­—: ${data.delimiter}`;
        }
        
        // ã‚­ãƒ¼åˆ—é¸æŠè‚¢æ›´æ–°
        function updateKeyColumnOptions() {
            const select = document.getElementById('keyColumn');
            select.innerHTML = '<option value="">ã‚­ãƒ¼åˆ—ã‚’é¸æŠ</option>';
            
            if (fileData.file1 && fileData.file2) {
                const common = fileData.file1.headers.filter(h => 
                    fileData.file2.headers.includes(h)
                );
                
                common.forEach(header => {
                    const option = document.createElement('option');
                    option.value = header;
                    option.textContent = header;
                    select.appendChild(option);
                });
                
                if (common.length > 0) {
                    select.value = common[0];
                }
            }
        }
        
        // æ¯”è¼ƒãƒœã‚¿ãƒ³çŠ¶æ…‹æ›´æ–°
        function updateCompareButton() {
            const btn = document.getElementById('compareBtn');
            btn.disabled = !(fileData.file1 && fileData.file2);
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«æ¯”è¼ƒ
        function compareFiles() {
            const keyColumn = document.getElementById('keyColumn').value;
            if (!keyColumn) {
                alert('ã‚­ãƒ¼åˆ—ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            if (!fileData.file1 || !fileData.file2) {
                alert('ä¸¡æ–¹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„');
                return;
            }
            
            // çµæœã‚¨ãƒªã‚¢ã‚’è¡¨ç¤ºï¼ˆHTMLæ§‹é€ ã‚’ä¿æŒï¼‰
            const resultsEl = document.getElementById('results');
            resultsEl.style.display = 'block';
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºï¼ˆå€‹åˆ¥è¦ç´ ã«ï¼‰
            const statsEl = document.getElementById('stats');
            const summaryEl = document.getElementById('summary');
            
            if (statsEl) statsEl.innerHTML = '<div class="loading">çµ±è¨ˆè¨ˆç®—ä¸­...</div>';
            if (summaryEl) summaryEl.innerHTML = '<div class="loading">æ¯”è¼ƒå‡¦ç†ä¸­...</div>';
            
            setTimeout(() => {
                try {
                    const result = performComparison(keyColumn);
                    comparisonResult = result;
                    displayResults(result);
                    console.log('ğŸ“Š æ¯”è¼ƒå®Œäº†:', result.stats);
                } catch (error) {
                    showError('æ¯”è¼ƒå‡¦ç†ã‚¨ãƒ©ãƒ¼: ' + error.message);
                    console.error('âŒ æ¯”è¼ƒã‚¨ãƒ©ãƒ¼:', error);
                }
            }, 100);
        }
        
        // æ¯”è¼ƒå‡¦ç†
        function performComparison(keyColumn) {
            console.log('ğŸ” æ¯”è¼ƒé–‹å§‹ - ã‚­ãƒ¼åˆ—:', keyColumn);
            
            const map1 = new Map();
            const map2 = new Map();
            
            // ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒãƒ—ã«æ ¼ç´
            fileData.file1.rows.forEach(row => {
                const key = row[keyColumn];
                if (key) map1.set(key, row);
            });
            
            fileData.file2.rows.forEach(row => {
                const key = row[keyColumn];
                if (key) map2.set(key, row);
            });
            
            console.log('ğŸ“Š ãƒãƒƒãƒ—ä½œæˆå®Œäº† - ãƒ•ã‚¡ã‚¤ãƒ«1:', map1.size, 'ãƒ•ã‚¡ã‚¤ãƒ«2:', map2.size);
            
            const added = [];
            const removed = [];
            const changed = [];
            const unchanged = [];
            
            // è¿½åŠ ã•ã‚ŒãŸãƒ¬ã‚³ãƒ¼ãƒ‰
            map2.forEach((row, key) => {
                if (!map1.has(key)) {
                    added.push({ key, data: row, type: 'added' });
                }
            });
            
            // å‰Šé™¤ã•ã‚ŒãŸãƒ¬ã‚³ãƒ¼ãƒ‰
            map1.forEach((row, key) => {
                if (!map2.has(key)) {
                    removed.push({ key, data: row, type: 'removed' });
                }
            });
            
            // å¤‰æ›´ã•ã‚ŒãŸãƒ¬ã‚³ãƒ¼ãƒ‰
            map1.forEach((row1, key) => {
                if (map2.has(key)) {
                    const row2 = map2.get(key);
                    const differences = {};
                    let hasChanges = false;
                    
                    Object.keys(row1).forEach(column => {
                        if (row1[column] !== row2[column]) {
                            differences[column] = {
                                old: row1[column] || '',
                                new: row2[column] || ''
                            };
                            hasChanges = true;
                        }
                    });
                    
                    if (hasChanges) {
                        changed.push({
                            key,
                            data1: row1,
                            data2: row2,
                            differences,
                            type: 'changed'
                        });
                    } else {
                        unchanged.push({ key, data: row1, type: 'unchanged' });
                    }
                }
            });
            
            console.log('ğŸ“ˆ æ¯”è¼ƒçµæœ - è¿½åŠ :', added.length, 'å‰Šé™¤:', removed.length, 'å¤‰æ›´:', changed.length);
            
            return {
                added,
                removed,
                changed,
                unchanged,
                stats: {
                    total1: fileData.file1.rows.length,
                    total2: fileData.file2.rows.length,
                    added: added.length,
                    removed: removed.length,
                    changed: changed.length,
                    unchanged: unchanged.length
                }
            };
        }
        
        // çµæœè¡¨ç¤º
        function displayResults(result) {
            console.log('ğŸ¨ çµæœè¡¨ç¤ºé–‹å§‹');
            
            // è¦ç´ ã®å­˜åœ¨ç¢ºèª
            const statsEl = document.getElementById('stats');
            const summaryEl = document.getElementById('summary');
            const detailsEl = document.getElementById('details');
            const addedEl = document.getElementById('added');
            const removedEl = document.getElementById('removed');
            const changedEl = document.getElementById('changed');
            
            if (!statsEl || !summaryEl || !detailsEl || !addedEl || !removedEl || !changedEl) {
                console.error('âŒ å¿…è¦ãªHTMLè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                showError('ç”»é¢è¡¨ç¤ºã‚¨ãƒ©ãƒ¼: å¿…è¦ãªè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            try {
                displayStats(result.stats);
                displaySummary(result);
                displayDetails(result);
                displayByType(result.added, 'added');
                displayByType(result.removed, 'removed');
                displayByType(result.changed, 'changed');
                console.log('âœ… çµæœè¡¨ç¤ºå®Œäº†');
            } catch (error) {
                console.error('âŒ çµæœè¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
                showError('çµæœè¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        // çµ±è¨ˆè¡¨ç¤º
        function displayStats(stats) {
            const statsEl = document.getElementById('stats');
            if (!statsEl) {
                console.error('âŒ statsè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            try {
                statsEl.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${stats.total1}</div>
                        <div class="stat-label">ãƒ•ã‚¡ã‚¤ãƒ«1</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.total2}</div>
                        <div class="stat-label">ãƒ•ã‚¡ã‚¤ãƒ«2</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" style="color: #4caf50">${stats.added}</div>
                        <div class="stat-label">è¿½åŠ </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" style="color: #f44336">${stats.removed}</div>
                        <div class="stat-label">å‰Šé™¤</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" style="color: #ffc107">${stats.changed}</div>
                        <div class="stat-label">å¤‰æ›´</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" style="color: #6c757d">${stats.unchanged}</div>
                        <div class="stat-label">å¤‰æ›´ãªã—</div>
                    </div>
                `;
                console.log('ğŸ“Š çµ±è¨ˆè¡¨ç¤ºå®Œäº†');
            } catch (error) {
                console.error('âŒ çµ±è¨ˆè¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
                showError('çµ±è¨ˆè¡¨ç¤ºã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }
        
        // ã‚µãƒãƒªãƒ¼è¡¨ç¤º
        function displaySummary(result) {
            const summaryEl = document.getElementById('summary');
            if (!summaryEl) {
                console.error('âŒ summaryè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            try {
                const total = result.added.length + result.removed.length + result.changed.length;
                let html = `<h3>æ¯”è¼ƒçµæœã‚µãƒãƒªãƒ¼</h3>`;
                html += `<p>å…¨ ${total} ä»¶ã®å¤‰æ›´ã‚’æ¤œå‡ºã—ã¾ã—ãŸ</p>`;
                
                if (result.added.length > 0) {
                    html += `<h4 style="color: #4caf50">è¿½åŠ : ${result.added.length}ä»¶</h4>`;
                    html += generateTable(result.added.slice(0, 5));
                }
                
                if (result.removed.length > 0) {
                    html += `<h4 style="color: #f44336">å‰Šé™¤: ${result.removed.length}ä»¶</h4>`;
                    html += generateTable(result.removed.slice(0, 5));
                }
                
                if (result.changed.length > 0) {
                    html += `<h4 style="color: #ffc107">å¤‰æ›´: ${result.changed.length}ä»¶</h4>`;
                    html += generateTable(result.changed.slice(0, 5));
                }
                
                if (total === 0) {
                    html += '<div style="text-align: center; padding: 20px; color: #4caf50;"><h4>ğŸ‰ å·®åˆ†ã¯ã‚ã‚Šã¾ã›ã‚“</h4><p>ä¸¡ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä¸€è‡´ã—ã¦ã„ã¾ã™</p></div>';
                }
                
                summaryEl.innerHTML = html;
                console.log('ğŸ“‹ ã‚µãƒãƒªãƒ¼è¡¨ç¤ºå®Œäº†');
            } catch (error) {
                console.error('âŒ ã‚µãƒãƒªãƒ¼è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
                showError('ã‚µãƒãƒªãƒ¼è¡¨ç¤ºã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }
        
        // è©³ç´°è¡¨ç¤º
        function displayDetails(result) {
            const detailsEl = document.getElementById('details');
            if (!detailsEl) {
                console.error('âŒ detailsè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            try {
                const all = [...result.added, ...result.removed, ...result.changed];
                detailsEl.innerHTML = `<h3>å…¨å¤‰æ›´è©³ç´° (${all.length}ä»¶)</h3>` + generateTable(all);
                console.log('ğŸ“Š è©³ç´°è¡¨ç¤ºå®Œäº†');
            } catch (error) {
                console.error('âŒ è©³ç´°è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
                showError('è©³ç´°è¡¨ç¤ºã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }
        
        // ã‚¿ã‚¤ãƒ—åˆ¥è¡¨ç¤º
        function displayByType(data, type) {
            const element = document.getElementById(type);
            if (!element) {
                console.error(`âŒ ${type}è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
                return;
            }
            
            try {
                const titles = {
                    added: 'è¿½åŠ ã•ã‚ŒãŸãƒ¬ã‚³ãƒ¼ãƒ‰',
                    removed: 'å‰Šé™¤ã•ã‚ŒãŸãƒ¬ã‚³ãƒ¼ãƒ‰',
                    changed: 'å¤‰æ›´ã•ã‚ŒãŸãƒ¬ã‚³ãƒ¼ãƒ‰'
                };
                element.innerHTML = `<h3>${titles[type]} (${data.length}ä»¶)</h3>` + generateTable(data);
                console.log(`ğŸ“Š ${type}è¡¨ç¤ºå®Œäº†`);
            } catch (error) {
                console.error(`âŒ ${type}è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:`, error);
                showError(`${type}è¡¨ç¤ºã‚¨ãƒ©ãƒ¼: ` + error.message);
            }
        }
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«ç”Ÿæˆ
        function generateTable(data) {
            try {
                if (!data || data.length === 0) return '<p>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                
                const allColumns = new Set();
                data.forEach(item => {
                    if (item && item.data) Object.keys(item.data).forEach(col => allColumns.add(col));
                    if (item && item.data1) Object.keys(item.data1).forEach(col => allColumns.add(col));
                    if (item && item.data2) Object.keys(item.data2).forEach(col => allColumns.add(col));
                });
                
                const columns = Array.from(allColumns);
                if (columns.length === 0) return '<p>è¡¨ç¤ºã™ã‚‹åˆ—ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                
                let html = '<table><thead><tr><th>ã‚¿ã‚¤ãƒ—</th><th>ã‚­ãƒ¼</th>';
                columns.forEach(col => html += `<th>${escapeHtml(col)}</th>`);
                html += '</tr></thead><tbody>';
                
                data.forEach(item => {
                    if (!item) return;
                    
                    const types = { added: 'è¿½åŠ ', removed: 'å‰Šé™¤', changed: 'å¤‰æ›´' };
                    html += `<tr class="diff-${item.type}">`;
                    html += `<td>${types[item.type] || 'ä¸æ˜'}</td>`;
                    html += `<td>${escapeHtml(item.key || '')}</td>`;
                    
                    columns.forEach(col => {
                        if (item.type === 'changed' && item.differences && item.differences[col]) {
                            const diff = item.differences[col];
                            html += `<td>æ—§:${escapeHtml(diff.old || '')}<br>æ–°:${escapeHtml(diff.new || '')}</td>`;
                        } else {
                            const value = (item.data && item.data[col]) || 
                                         (item.data1 && item.data1[col]) || 
                                         (item.data2 && item.data2[col]) || '';
                            html += `<td>${escapeHtml(value)}</td>`;
                        }
                    });
                    
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
                return html;
            } catch (error) {
                console.error('âŒ ãƒ†ãƒ¼ãƒ–ãƒ«ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
                return '<p>ãƒ†ãƒ¼ãƒ–ãƒ«ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>';
            }
        }
        
        // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°
        function escapeHtml(text) {
            if (typeof text !== 'string') text = String(text);
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }
        
        // CSVå‡ºåŠ›
        function exportCSV(type) {
            if (!comparisonResult) {
                alert('æ¯”è¼ƒçµæœãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            let data = [];
            if (type === 'all') {
                data = [...comparisonResult.added, ...comparisonResult.removed, 
                       ...comparisonResult.changed, ...comparisonResult.unchanged];
            } else {
                data = [...comparisonResult.added, ...comparisonResult.removed, ...comparisonResult.changed];
            }
            
            if (data.length === 0) {
                alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const allColumns = new Set();
            data.forEach(item => {
                if (item.data) Object.keys(item.data).forEach(col => allColumns.add(col));
                if (item.data1) Object.keys(item.data1).forEach(col => allColumns.add(col));
                if (item.data2) Object.keys(item.data2).forEach(col => allColumns.add(col));
            });
            
            const columns = Array.from(allColumns);
            let csv = 'ã‚¿ã‚¤ãƒ—,ã‚­ãƒ¼,' + columns.join(',') + '\n';
            
            data.forEach(item => {
                const types = { added: 'è¿½åŠ ', removed: 'å‰Šé™¤', changed: 'å¤‰æ›´', unchanged: 'å¤‰æ›´ãªã—' };
                let row = [types[item.type], item.key];
                
                columns.forEach(col => {
                    if (item.type === 'changed' && item.differences[col]) {
                        const diff = item.differences[col];
                        row.push(`"æ—§:${diff.old} æ–°:${diff.new}"`);
                    } else {
                        const value = item.data?.[col] || item.data1?.[col] || item.data2?.[col] || '';
                        row.push(`"${value}"`);
                    }
                });
                
                csv += row.join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tsv_comparison_${type}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            console.log('ğŸ“ CSVå‡ºåŠ›å®Œäº†');
        }
        
        // ã‚¯ãƒªã‚¢
        function clearAll() {
            if (comparisonResult && !confirm('ç¾åœ¨ã®æ¯”è¼ƒçµæœã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            // ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
            fileData = { file1: null, file2: null };
            comparisonResult = null;
            originalFileContents = { file1: null, file2: null };
            originalFileNames = { file1: null, file2: null };
            
            // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢
            document.getElementById('file1').value = '';
            document.getElementById('file2').value = '';
            document.getElementById('info1').innerHTML = '';
            document.getElementById('info2').innerHTML = '';
            
            // é¸æŠé …ç›®ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('keyColumn').innerHTML = '<option value="">ã‚­ãƒ¼åˆ—ã‚’é¸æŠ</option>';
            document.getElementById('delimiter').value = 'auto';
            
            // çµæœã‚¨ãƒªã‚¢ã‚’å®Œå…¨ã«ã‚¯ãƒªã‚¢
            const resultsEl = document.getElementById('results');
            resultsEl.style.display = 'none';
            
            // å„çµæœè¦ç´ ã‚’å€‹åˆ¥ã«ã‚¯ãƒªã‚¢
            const elementsToeClear = ['stats', 'summary', 'details', 'added', 'removed', 'changed'];
            elementsToeClear.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.innerHTML = '';
                }
            });
            
            // ã‚¿ãƒ–ã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã™
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // æœ€åˆã®ã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            const firstTab = document.querySelector('.tab');
            const firstContent = document.getElementById('summary');
            if (firstTab && firstContent) {
                firstTab.classList.add('active');
                firstContent.classList.add('active');
            }
            
            // ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’æ›´æ–°
            updateCompareButton();
            
            // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚å‰Šé™¤
            document.querySelectorAll('.error').forEach(error => error.remove());
            
            console.log('ğŸ—‘ï¸ å…¨ã¦ã‚¯ãƒªã‚¢å®Œäº† - ãƒ•ã‚¡ã‚¤ãƒ«ã€çµæœã€è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
        }
        
        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function resetResultsDisplay() {
            // çµæœã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤º
            const resultsEl = document.getElementById('results');
            if (resultsEl) {
                resultsEl.style.display = 'none';
            }
            
            // å„çµæœã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚¯ãƒªã‚¢
            const resultElements = [
                'stats', 'summary', 'details', 
                'added', 'removed', 'changed'
            ];
            
            resultElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.innerHTML = '';
                }
            });
            
            // ã‚¿ãƒ–çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // ã‚µãƒãƒªãƒ¼ã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            const summaryTab = document.querySelector('.tab');
            const summaryContent = document.getElementById('summary');
            if (summaryTab && summaryContent) {
                summaryTab.classList.add('active');
                summaryContent.classList.add('active');
            }
            
            console.log('ğŸ§¹ çµæœè¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
        }
        
        function showError(message) {
            console.error('ğŸš¨ ã‚¨ãƒ©ãƒ¼:', message);
            const error = document.createElement('div');
            error.className = 'error';
            error.textContent = message;
            document.querySelector('.container').appendChild(error);
            
            setTimeout(() => error.remove(), 5000);
        }
        
        // åˆæœŸåŒ–å®Œäº†
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ DOMèª­ã¿è¾¼ã¿å®Œäº†');
            
            // å¿…è¦ãªè¦ç´ ã®å­˜åœ¨ç¢ºèª
            const requiredElements = ['stats', 'summary', 'details', 'added', 'removed', 'changed'];
            const missingElements = [];
            
            requiredElements.forEach(id => {
                if (!document.getElementById(id)) {
                    missingElements.push(id);
                }
            });
            
            if (missingElements.length > 0) {
                console.error('âŒ ä¸è¶³ã—ã¦ã„ã‚‹è¦ç´ :', missingElements);
                showError('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: å¿…è¦ãªç”»é¢è¦ç´ ãŒä¸è¶³ã—ã¦ã„ã¾ã™ - ' + missingElements.join(', '));
            } else {
                console.log('âœ… å…¨ã¦ã®å¿…è¦è¦ç´ ãŒç¢ºèªã§ãã¾ã—ãŸ');
            }
        });
        
        console.log('âœ… TSVãƒ„ãƒ¼ãƒ«åˆæœŸåŒ–å®Œäº†');
    </script>
</body>
</html>
